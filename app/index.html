<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' ws: blob:; style-src 'self' 'unsafe-inline';">
    <title>Electron P2P Voice Chat</title>
    <link rel="stylesheet" href="main.css">
    <style>
        /* Slider stilleri */
        .slider-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; width: 100%; }
        .slider-group label { font-size: 14px; font-weight: bold; width: 100px; }
        .slider-group input { flex: 1; cursor: pointer; }
        .slider-val { font-size: 12px; width: 35px; text-align: right; font-family: monospace; }
        
        /* KullanÄ±cÄ± kartÄ±ndaki slider */
        .user-volume { margin-top: 5px; display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .user-volume input { flex: 1; height: 5px; cursor: pointer; }
        .user-volume span { font-size: 11px; width: 30px; text-align: right; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”Š P2P Sesli Sohbet</h1>
    <div id="status">HazÄ±r...</div>
    
    <div class="input-group">
        <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±nÄ±z" value="User">
    </div>

    <div id="settingsPanel" style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #eee; display:none;">
        <div class="slider-group">
            <label>ğŸ™ï¸ Mic Ses:</label>
            <input type="range" id="micVolume" min="0" max="200" value="100">
            <span id="micVal" class="slider-val">100%</span>
        </div>
        <div class="slider-group">
            <label>ğŸ§ Genel Ses:</label>
            <input type="range" id="masterVolume" min="0" max="100" value="100">
            <span id="masterVal" class="slider-val">100%</span>
        </div>
    </div>
    
    <div class="controls">
        <button id="btnConnect">Sohbete KatÄ±l</button>
        <div class="audio-controls" id="audioControls">
            <button id="btnToggleMic">ğŸ¤ Mikrofon AÃ§Ä±k</button>
            <button id="btnToggleSound">ğŸ”Š Ses Duyuluyor</button>
        </div>
    </div>
    
    <div id="error-log"></div>

    <div id="users">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">BaÄŸlÄ± KullanÄ±cÄ±lar</h3>
        <div id="userList"></div>
    </div>
</div>

<div id="audioContainer"></div>

<script>
    window.onload = () => {
        if (!window.SimplePeer) document.getElementById('error-log').innerText = "HATA: SimplePeer yÃ¼klenemedi.";
    };

    const PORT = 8080;
    // DÄ°KKAT: Ngrok kullanÄ±yorsan burayÄ± gÃ¼ncelle
    const WS_URL = `ws://localhost:${PORT}`; 
    
    let socket;
    let localStream;      
    let processedStream;  
    let micGainNode;      
    let audioContext;     

    let peers = {}; 
    let userNames = {};
    let isMicMuted = false;
    let isDeafened = false;

    // UI Elementleri
    const inputUsername = document.getElementById('username');
    const statusDiv = document.getElementById('status');
    const userListDiv = document.getElementById('userList');
    const btnConnect = document.getElementById('btnConnect');
    const btnToggleMic = document.getElementById('btnToggleMic');
    const btnToggleSound = document.getElementById('btnToggleSound');
    const audioControls = document.getElementById('audioControls');
    const settingsPanel = document.getElementById('settingsPanel');
    
    // Slider Elementleri
    const micSlider = document.getElementById('micVolume');
    const micVal = document.getElementById('micVal');
    const masterSlider = document.getElementById('masterVolume');
    const masterVal = document.getElementById('masterVal');

    inputUsername.value += "_" + Math.floor(Math.random() * 1000);

    // --- SES AYARLARI MANTIÄI ---
    micSlider.addEventListener('input', (e) => {
        const val = e.target.value;
        micVal.innerText = val + "%";
        if (micGainNode) micGainNode.gain.value = val / 100; 
    });

    masterSlider.addEventListener('input', (e) => {
        const val = e.target.value;
        masterVal.innerText = val + "%";
        document.querySelectorAll('audio').forEach(audio => {
            audio.volume = val / 100;
        });
    });

    // --- BAÄLANMA Ä°ÅLEMÄ° ---
    btnConnect.addEventListener('click', async () => {
        const name = inputUsername.value;
        btnConnect.disabled = true;
        inputUsername.disabled = true;
        
        statusDiv.innerText = "Ses motoru baÅŸlatÄ±lÄ±yor...";
        try {
            const rawStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(rawStream);
            
            micGainNode = audioContext.createGain();
            micGainNode.gain.value = 1.0; 
            
            const destination = audioContext.createMediaStreamDestination();
            
            source.connect(micGainNode);
            micGainNode.connect(destination);
            
            localStream = rawStream; 
            processedStream = destination.stream; 

            statusDiv.innerText = "Sunucuya baÄŸlanÄ±lÄ±yor...";
            
            btnConnect.style.display = 'none';
            audioControls.style.display = 'flex';
            settingsPanel.style.display = 'block'; 
            
            userNames["me"] = name + " (Ben)";
            addUserUI("me", userNames["me"], true);
            
            attachVisualizer(processedStream, "me"); 

            connectSocket(name);
        } catch (err) {
            console.error(err);
            statusDiv.innerText = "HATA: " + err.message;
            btnConnect.disabled = false;
        }
    });

    // --- SES KONTROLLERÄ° ---
    function setMicState(mute) {
        if (!localStream) return;
        const track = localStream.getAudioTracks()[0];
        isMicMuted = mute;
        track.enabled = !mute; 

        if (isMicMuted) {
            btnToggleMic.innerText = "ğŸ”‡ Mikrofon KapalÄ±";
            btnToggleMic.style.backgroundColor = "#ff4757";
            const bar = document.getElementById('meter-fill-me');
            if(bar) bar.style.backgroundColor = "#ccc";
        } else {
            btnToggleMic.innerText = "ğŸ¤ Mikrofon AÃ§Ä±k";
            btnToggleMic.style.backgroundColor = "#2ecc71";
            const bar = document.getElementById('meter-fill-me');
            if(bar) bar.style.backgroundColor = "#2ecc71";
        }
    }

    btnToggleMic.addEventListener('click', () => {
        if (isDeafened) return alert("HoparlÃ¶r kapalÄ±yken mikrofonu aÃ§amazsÄ±nÄ±z!");
        setMicState(!isMicMuted);
    });

    btnToggleSound.addEventListener('click', () => {
        isDeafened = !isDeafened;
        document.querySelectorAll('audio').forEach(audio => audio.muted = isDeafened);

        if (isDeafened) {
            btnToggleSound.innerText = "ğŸ”‡ Ses KapalÄ±";
            btnToggleSound.style.backgroundColor = "#ff4757";
            if (!isMicMuted) setMicState(true);
        } else {
            btnToggleSound.innerText = "ğŸ”Š Ses Duyuluyor";
            btnToggleSound.style.backgroundColor = "#2ecc71";
        }
    });

    // --- WEBSOCKET ---
    function connectSocket(name) {
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            statusDiv.innerText = "Odaya giriliyor...";
            socket.send(JSON.stringify({ type: 'join', name: name }));
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'user-list') {
                    statusDiv.innerText = `Sohbet OdasÄ± (${data.users.length + 1} KiÅŸi)`;
                    data.users.forEach(user => {
                        userNames[user.id] = user.name;
                        createPeer(user.id, user.name, true);
                    });
                } 
                else if (data.type === 'user-joined') {
                    statusDiv.innerText = `${data.name} katÄ±ldÄ±.`;
                    userNames[data.id] = data.name;
                    updateNameUI(data.id, data.name);
                } 
                else if (data.type === 'signal') handleSignal(data.senderId, data.signal);
                else if (data.type === 'user-left') removePeer(data.id);
            } catch (e) { console.error(e); }
        };
        socket.onerror = () => statusDiv.innerText = "Sunucu BaÄŸlantÄ± HatasÄ±!";
    }

    // --- P2P ---
    function createPeer(targetId, name, initiator) {
        try {
            const peer = new window.SimplePeer({
                initiator: initiator,
                stream: processedStream,
                trickle: false,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('signal', signal => {
                socket.send(JSON.stringify({ type: 'signal', targetId: targetId, signal: signal }));
            });

            peer.on('stream', stream => {
                addAudioElement(targetId, stream);
                const finalName = userNames[targetId] || name || "Bilinmeyen";
                addUserUI(targetId, finalName, true);
                attachVisualizer(stream, targetId);
            });

            peer.on('close', () => removePeer(targetId));
            peer.on('error', err => console.error("Peer hatasÄ±:", err));

            peers[targetId] = peer;
            if(!document.getElementById(`user-${targetId}`)) {
                const finalName = userNames[targetId] || name || "Bilinmeyen";
                addUserUI(targetId, finalName, false);
            }
        } catch (e) { console.error(e); }
    }

    function handleSignal(senderId, signal) {
        if (!peers[senderId]) {
            const storedName = userNames[senderId] || "Bilinmeyen";
            createPeer(senderId, storedName, false);
        }
        if (peers[senderId]) peers[senderId].signal(signal);
    }

    // --- UI YARDIMCILARI ---
    function addUserUI(id, name, isConnected) {
        let el = document.getElementById(`user-${id}`);
        const statusText = isConnected ? 'CanlÄ±' : 'BaÄŸlanÄ±yor...';
        
        if (!el) {
            el = document.createElement('div');
            el.id = `user-${id}`;
            el.className = 'user-card';
            userListDiv.appendChild(el);
        }
        
        el.style.backgroundColor = isConnected ? '#e8f5e9' : '#fff3e0';
        
        // KÄ°ÅÄ°YE Ã–ZEL SES AYARI + YÃœZDE GÃ–STERGESÄ°
        let volumeControlHTML = '';
        if (id !== 'me') {
            volumeControlHTML = `
                <div class="user-volume">
                    <label>ğŸ”Š</label>
                    <input type="range" min="0" max="100" value="100" 
                           oninput="
                               document.getElementById('audio-${id}').volume = this.value/100;
                               document.getElementById('vol-val-${id}').innerText = this.value + '%';
                           ">
                    <span id="vol-val-${id}">100%</span>
                </div>
            `;
        }

        el.innerHTML = `
            <div class="user-info">
                <span class="user-name">${name}</span>
                <span class="user-status">${statusText}</span>
            </div>
            ${volumeControlHTML}
            <div class="meter-bg">
                <div id="meter-fill-${id}" class="meter-fill"></div>
            </div>
        `;
    }

    function updateNameUI(id, newName) {
        const el = document.getElementById(`user-${id}`);
        if (el) {
            const nameSpan = el.querySelector('.user-name');
            if (nameSpan) nameSpan.innerText = newName;
        }
    }

    function attachVisualizer(stream, id) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 64; 
        source.connect(analyser);
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        const barElement = document.getElementById(`meter-fill-${id}`);

        function updateMeter() {
            if (!barElement) return; 
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            const average = sum / dataArray.length;
            const percent = Math.min(100, average * 2.5); 
            barElement.style.width = percent + "%";
            requestAnimationFrame(updateMeter);
        }
        updateMeter();
    }

    function addAudioElement(id, stream) {
        if (document.getElementById(`audio-${id}`)) return;
        const audio = document.createElement('audio');
        audio.id = `audio-${id}`;
        audio.srcObject = stream;
        audio.autoplay = true;
        
        const masterVol = document.getElementById('masterVolume').value;
        audio.volume = masterVol / 100;

        if (isDeafened) audio.muted = true;
        document.getElementById('audioContainer').appendChild(audio);
    }

    function removePeer(id) {
        if(peers[id]) { peers[id].destroy(); delete peers[id]; }
        const el = document.getElementById(`user-${id}`); if(el) el.remove();
        const aud = document.getElementById(`audio-${id}`); if(aud) aud.remove();
        delete userNames[id];
    }
</script>
</body>
</html>